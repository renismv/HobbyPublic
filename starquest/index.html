<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#7c5cff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Fathayya Star Quest</title>
  <style>
    :root {
      --purple: #7c5cff;
      --pink: #ff6fb1;
      --yellow: #ffd54f;
      --teal: #37c9c9;
      --bg: #f7f3ff;
      --card: #ffffff;
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --shadow: 0 8px 24px rgba(124, 92, 255, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Trebuchet MS", "Arial Rounded MT Bold", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: linear-gradient(135deg, #7c5cff 0%, #ff6fb1 100%);
      color: white;
      padding: 24px 16px 32px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 3;
    }

    header h1 {
      margin: 0 0 6px;
      font-size: 1.9rem;
    }

    header p {
      margin: 0;
      font-size: 1rem;
      opacity: 0.9;
    }

    .container {
      padding: 16px;
      max-width: 980px;
      margin: 0 auto 48px;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .stats {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .stat {
      background: #fff6e6;
      border-radius: 16px;
      padding: 12px;
      text-align: center;
    }

    .stat h2 {
      margin: 0;
      font-size: 2rem;
    }

    .tag {
      display: inline-block;
      background: #f0ecff;
      color: var(--purple);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mission {
      display: grid;
      grid-template-columns: 70px 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 16px;
      background: #f5f9ff;
      border: 2px solid transparent;
    }

    .mission.done {
      border-color: #7cffa6;
      background: #ecfff4;
    }

    .mission-time {
      font-weight: bold;
      color: var(--purple);
    }

    .mission-title {
      font-size: 1rem;
    }

    .mission-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    button {
      border: none;
      background: var(--purple);
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
    }

    button.secondary {
      background: #f0ecff;
      color: var(--purple);
    }

    button.ghost {
      background: transparent;
      color: var(--purple);
      border: 2px dashed var(--purple);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #dcd6ff;
      font-size: 0.9rem;
    }

    .reward-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .reward {
      background: #fff8f0;
      border-radius: 16px;
      padding: 12px;
      border: 2px solid #ffe3bd;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .reward.redeemed {
      background: #f1fff8;
      border-color: #b5f7d1;
    }

    .parent-banner {
      padding: 10px;
      background: #fff1f9;
      border-radius: 14px;
      border: 2px dashed #ff9bd1;
      margin-top: 12px;
    }

    .backup-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .note {
      background: #f0fff6;
      border-radius: 14px;
      padding: 10px;
      border: 1px dashed #86f0c5;
      font-size: 0.9rem;
      margin-top: 8px;
    }

    .confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      display: none;
      z-index: 10;
    }

    .confetti.active {
      display: block;
    }

    .confetti span {
      position: absolute;
      width: 10px;
      height: 16px;
      background: var(--pink);
      top: -20px;
      animation: confetti-fall 1.8s ease-in forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
      }
    }

    @media (max-width: 700px) {
      header h1 {
        font-size: 1.6rem;
      }

      .mission {
        grid-template-columns: 60px 1fr;
      }

      .mission button {
        grid-column: span 2;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üåü Fathayya Star Quest</h1>
    <p>Mission schedule + rewards (kid-friendly, parent-approved!)</p>
  </header>

  <div class="container">
    <section class="card">
      <h2>üöÄ Today&rsquo;s Quest</h2>
      <div class="stats">
        <div class="stat">
          <div>‚≠ê Stars</div>
          <h2 id="starCount">0</h2>
          <div id="weekLabel">Weekly adventure</div>
        </div>
        <div class="stat">
          <div>‚úÖ Missions done</div>
          <h2 id="doneCount">0</h2>
          <div id="dateLabel"></div>
        </div>
        <div class="stat">
          <div>üõ°Ô∏è Parent mode</div>
          <h2 id="parentStatus">Locked</h2>
          <button class="secondary" id="parentUnlockButton">Unlock</button>
        </div>
      </div>
      <div class="note">
        üí§ Sleep note: <strong>Sleep late Fri + Sat, wake late Sat + Sun</strong>.
      </div>
    </section>

    <section class="card">
      <h3>üìÖ Mission Schedule</h3>
      <div class="note">
        <strong>Special days:</strong>
        Wed ‚Üí Piano 17:15, Jaanu after dinner. Thu ‚Üí Swimming 18:30.
        Weekend ‚Üí combined missions, Swimming only Sunday, Jaanu Saturday ~11.
      </div>
      <div id="schedule" class="schedule-list"></div>
    </section>

    <section class="card">
      <h3>üß© Add Task or Reminder</h3>
      <div class="form-grid">
        <div>
          <label for="taskTitle">Title</label>
          <input id="taskTitle" placeholder="e.g. Read 10 pages" />
        </div>
        <div>
          <label for="taskTime">Time</label>
          <input id="taskTime" type="time" />
        </div>
        <div>
          <label for="taskDate">Date</label>
          <input id="taskDate" type="date" />
        </div>
        <div>
          <label for="taskStars">Stars</label>
          <input id="taskStars" type="number" min="0" max="10" value="1" />
        </div>
        <div>
          <label for="taskType">Type</label>
          <select id="taskType">
            <option value="mission">Mission</option>
            <option value="reminder">Reminder</option>
          </select>
        </div>
      </div>
      <button id="addTaskButton">Add to Quest</button>
    </section>

    <section class="card">
      <h3>üõçÔ∏è Reward Shop (Parent unlock required)</h3>
      <div class="reward-grid" id="rewardGrid"></div>
      <div class="parent-banner">
        <strong>Parent controls:</strong> Set a code, then unlock for 10 minutes when needed.
        <div class="form-grid">
          <div>
            <label for="parentCode">Parent code</label>
            <input id="parentCode" type="password" placeholder="Create or enter" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="saveParentCode">Save / Change Code</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>üíæ Backup & Restore</h3>
      <p>Export your progress or restore it from a backup file (works on iPad Safari).</p>
      <div class="backup-buttons">
        <button class="secondary" id="exportButton">Export Backup</button>
        <label class="ghost" for="importFile" style="display:inline-flex;align-items:center;gap:8px;">
          üìÇ Import Backup
        </label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </section>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    const storageKey = "starquestState";
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    const builtInRewards = [
      { id: "reward-movie", title: "üé¨ Family movie", cost: 12, redeemed: false },
      { id: "reward-park", title: "üõù Park visit", cost: 10, redeemed: false },
      { id: "reward-craft", title: "üé® Craft time", cost: 8, redeemed: false },
      { id: "reward-dessert", title: "üç® Special dessert", cost: 6, redeemed: false }
    ];

    const baseWeekdaySchedule = [
      { time: "07:00", title: "Wake up & stretch", stars: 1, tag: "üåû" },
      { time: "07:20", title: "Morning routine (wash + dress)", stars: 1, tag: "üßº" },
      { time: "07:45", title: "Breakfast power-up", stars: 1, tag: "ü•£" },
      { time: "08:30", title: "School time / learning", stars: 2, tag: "üìö" },
      { time: "15:30", title: "Snack + chill", stars: 1, tag: "üçå" },
      { time: "16:00", title: "Homework / learning", stars: 2, tag: "Uppa can help" },
      { time: "17:00", title: "Play / outside fun", stars: 1, tag: "üèÄ" },
      { time: "18:30", title: "Dinner time", stars: 1, tag: "üçõ" },
      { time: "19:00", title: "Homework / learning", stars: 2, tag: "Uppa can help" },
      { time: "19:20", title: "Reading time", stars: 1, tag: "üìñ" },
      { time: "19:45", title: "Flexible time", stars: 1, tag: "Family time" },
      { time: "20:15", title: "Night routine + tidy", stars: 1, tag: "üåô" }
    ];

    const weekendSchedule = [
      { time: "08:30", title: "Slow wake-up", stars: 1, tag: "üò¥" },
      { time: "09:30", title: "Weekend combined missions", stars: 3, tag: "üß©" },
      { time: "12:30", title: "Family lunch", stars: 1, tag: "üç≤" },
      { time: "15:00", title: "Adventure time", stars: 1, tag: "üö≤" },
      { time: "18:30", title: "Dinner time", stars: 1, tag: "üçõ" },
      { time: "20:00", title: "Story + chill", stars: 1, tag: "üìö" }
    ];

    let state = loadState();

    function loadState() {
      const raw = localStorage.getItem(storageKey);
      if (raw) {
        try {
          return JSON.parse(raw);
        } catch (error) {
          console.warn("Could not parse saved state", error);
        }
      }
      return {
        stars: 0,
        completions: {},
        customTasks: [],
        rewards: builtInRewards,
        parent: {
          hash: "",
          unlockedUntil: 0
        },
        lastWeekKey: ""
      };
    }

    function saveState() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function getWeekKey(date) {
      const firstDay = new Date(date.getFullYear(), 0, 1);
      const dayOffset = (date - firstDay) / 86400000;
      const week = Math.floor((dayOffset + firstDay.getDay()) / 7);
      return `${date.getFullYear()}-W${week}`;
    }

    function ensureWeekReset() {
      const weekKey = getWeekKey(new Date());
      if (state.lastWeekKey && state.lastWeekKey !== weekKey) {
        state.completions = {};
      }
      state.lastWeekKey = weekKey;
      saveState();
      document.getElementById("weekLabel").textContent = `Week ${weekKey}`;
    }

    function slugify(value) {
      return value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function taskIdFor(task) {
      return slugify(`${task.dayKey || "daily"}-${task.time}-${task.title}`);
    }

    function dateKey(date) {
      return date.toISOString().slice(0, 10);
    }

    function getScheduleForDate(date) {
      const day = date.getDay();
      const isWeekend = day === 0 || day === 6;
      const schedule = (isWeekend ? weekendSchedule : baseWeekdaySchedule).map((task) => ({
        ...task,
        dayKey: isWeekend ? "weekend" : "weekday"
      }));

      if (day === 3) {
        schedule.push({ time: "17:15", title: "Piano practice", stars: 2, tag: "üéπ", dayKey: "wednesday" });
        schedule.push({ time: "20:00", title: "Jaanu after dinner", stars: 1, tag: "üß∏", dayKey: "wednesday" });
      }

      if (day === 4) {
        schedule.push({ time: "18:30", title: "Swimming", stars: 2, tag: "üèä", dayKey: "thursday" });
      }

      if (day === 6) {
        schedule.push({ time: "11:00", title: "Jaanu visit", stars: 1, tag: "üß∏", dayKey: "saturday" });
      }

      if (day === 0) {
        schedule.push({ time: "16:00", title: "Swimming", stars: 2, tag: "üèä", dayKey: "sunday" });
      }

      schedule.sort((a, b) => a.time.localeCompare(b.time));
      return schedule;
    }

    function getTasksForDate(date) {
      const key = dateKey(date);
      const custom = state.customTasks.filter((task) => task.date === key);
      const builtIn = getScheduleForDate(date);
      return [...builtIn, ...custom].map((task) => ({
        ...task,
        id: task.id || taskIdFor(task)
      }));
    }

    function isTaskDone(taskId, date) {
      const key = dateKey(date);
      return Boolean(state.completions[key]?.[taskId]);
    }

    function markTaskDone(task, date) {
      const key = dateKey(date);
      if (!state.completions[key]) {
        state.completions[key] = {};
      }
      if (!state.completions[key][task.id]) {
        state.completions[key][task.id] = true;
        if (task.stars > 0) {
          state.stars += task.stars;
        }
      }
      saveState();
      render();
    }

    function renderSchedule() {
      const container = document.getElementById("schedule");
      const today = new Date();
      const tasks = getTasksForDate(today);
      container.innerHTML = "";
      let doneCount = 0;

      tasks.forEach((task) => {
        const done = isTaskDone(task.id, today);
        if (done) doneCount += 1;
        const card = document.createElement("div");
        card.className = `mission ${done ? "done" : ""}`;
        card.innerHTML = `
          <div class="mission-time">${task.time}</div>
          <div>
            <div class="mission-title">${task.title}</div>
            <div class="mission-meta">${task.tag ? `${task.tag} ` : ""}${task.type === "reminder" ? "Reminder" : `${task.stars}‚≠ê`}</div>
          </div>
        `;

        const button = document.createElement("button");
        button.textContent = done ? "Done!" : "Mark done";
        button.disabled = done;
        button.addEventListener("click", () => markTaskDone(task, today));
        card.appendChild(button);
        container.appendChild(card);
      });

      document.getElementById("doneCount").textContent = doneCount;
      document.getElementById("dateLabel").textContent = dayNames[today.getDay()];
    }

    function renderRewards() {
      const grid = document.getElementById("rewardGrid");
      grid.innerHTML = "";
      state.rewards.forEach((reward) => {
        const card = document.createElement("div");
        card.className = `reward ${reward.redeemed ? "redeemed" : ""}`;
        card.innerHTML = `
          <strong>${reward.title}</strong>
          <div>${reward.cost}‚≠ê needed</div>
          <div>${reward.redeemed ? "‚úÖ Redeemed" : "Ready to redeem"}</div>
        `;
        const button = document.createElement("button");
        button.textContent = reward.redeemed ? "Enjoy!" : "Redeem";
        button.disabled = reward.redeemed || state.stars < reward.cost;
        button.addEventListener("click", () => redeemReward(reward));
        card.appendChild(button);
        grid.appendChild(card);
      });
    }

    function render() {
      ensureWeekReset();
      document.getElementById("starCount").textContent = state.stars;
      const parentStatus = document.getElementById("parentStatus");
      parentStatus.textContent = isParentUnlocked() ? "Unlocked" : "Locked";
      renderSchedule();
      renderRewards();
    }

    function addTask() {
      const title = document.getElementById("taskTitle").value.trim();
      const time = document.getElementById("taskTime").value;
      const dateValue = document.getElementById("taskDate").value;
      const stars = Number(document.getElementById("taskStars").value || 0);
      const type = document.getElementById("taskType").value;

      if (!title || !time || !dateValue) {
        alert("Please fill in title, time, and date.");
        return;
      }

      const task = {
        id: `custom-${Date.now()}`,
        title,
        time,
        date: dateValue,
        stars: type === "reminder" ? 0 : stars,
        type,
        tag: type === "reminder" ? "üîî" : "‚ú®"
      };

      state.customTasks.push(task);
      saveState();
      render();

      document.getElementById("taskTitle").value = "";
      document.getElementById("taskTime").value = "";
      document.getElementById("taskDate").value = "";
    }

    function isParentUnlocked() {
      return Date.now() < state.parent.unlockedUntil;
    }

    async function hashCode(code) {
      const data = new TextEncoder().encode(code);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(digest))
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
    }

    async function saveParentCode() {
      const code = document.getElementById("parentCode").value.trim();
      if (!code) {
        alert("Enter a parent code first.");
        return;
      }
      state.parent.hash = await hashCode(code);
      saveState();
      alert("Parent code saved!");
      document.getElementById("parentCode").value = "";
    }

    async function unlockParentMode() {
      if (!state.parent.hash) {
        alert("Please set a parent code first.");
        return;
      }
      const code = prompt("Enter parent code to unlock:");
      if (!code) return;
      const hash = await hashCode(code);
      if (hash === state.parent.hash) {
        state.parent.unlockedUntil = Date.now() + 10 * 60 * 1000;
        saveState();
        render();
        alert("Parent mode unlocked for 10 minutes.");
      } else {
        alert("Incorrect code.");
      }
    }

    function redeemReward(reward) {
      if (!isParentUnlocked()) {
        unlockParentMode().then(() => {
          if (isParentUnlocked()) {
            redeemReward(reward);
          }
        });
        return;
      }

      if (state.stars < reward.cost) {
        alert("Not enough stars yet!");
        return;
      }

      reward.redeemed = true;
      state.stars -= reward.cost;
      saveState();
      launchConfetti();
      render();
    }

    function launchConfetti() {
      const confetti = document.getElementById("confetti");
      confetti.innerHTML = "";
      for (let i = 0; i < 25; i += 1) {
        const piece = document.createElement("span");
        piece.style.left = `${Math.random() * 100}%`;
        piece.style.background = ["#ff6fb1", "#7c5cff", "#ffd54f", "#37c9c9"][i % 4];
        piece.style.animationDelay = `${Math.random() * 0.4}s`;
        confetti.appendChild(piece);
      }
      confetti.classList.add("active");
      setTimeout(() => confetti.classList.remove("active"), 1900);
    }

    function exportBackup() {
      const data = {
        ...state,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement("a");
      anchor.href = url;
      anchor.download = "starquest-backup.json";
      anchor.click();
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!parsed || typeof parsed !== "object") throw new Error("Invalid file");
          state = {
            stars: parsed.stars || 0,
            completions: parsed.completions || {},
            customTasks: parsed.customTasks || [],
            rewards: parsed.rewards || builtInRewards,
            parent: parsed.parent || { hash: "", unlockedUntil: 0 },
            lastWeekKey: parsed.lastWeekKey || ""
          };
          saveState();
          render();
          alert("Backup restored!");
        } catch (error) {
          alert("Could not import backup.");
        }
      };
      reader.readAsText(file);
    }

    document.getElementById("addTaskButton").addEventListener("click", addTask);
    document.getElementById("parentUnlockButton").addEventListener("click", unlockParentMode);
    document.getElementById("saveParentCode").addEventListener("click", saveParentCode);
    document.getElementById("exportButton").addEventListener("click", exportBackup);
    document.getElementById("importFile").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        importBackup(file);
        event.target.value = "";
      }
    });

    render();
  </script>
</body>
</html>
